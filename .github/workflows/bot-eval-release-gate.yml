name: Bot Eval Release Gate

on:
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch:
    inputs:
      profile:
        description: Which gate profile to run
        required: true
        default: pr
        type: choice
        options:
          - pr
          - nightly

permissions:
  contents: read

concurrency:
  group: bot-eval-release-gate-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  OLLAMA_BASE_URL: ${{ vars.OLLAMA_BASE_URL || 'http://127.0.0.1:11434' }}
  BOT_EVAL_MODEL: ${{ vars.BOT_EVAL_MODEL || 'qwen2.5-coder:14b' }}
  BOT_EVAL_PLANNER_MODEL: ${{ vars.BOT_EVAL_PLANNER_MODEL || 'deepseek-r1:8b' }}
  BOT_EVAL_REVIEWER_MODEL: ${{ vars.BOT_EVAL_REVIEWER_MODEL || 'qwen2.5:3b' }}
  BOT_EVAL_JSON_REPAIR_MODEL: ${{ vars.BOT_EVAL_JSON_REPAIR_MODEL || 'qwen2.5:7b' }}
  BOT_EVAL_DETERMINISTIC_FALLBACK: ${{ vars.BOT_EVAL_DETERMINISTIC_FALLBACK || 'on-fail' }}
  BOT_EVAL_TIMEOUT_SEC: ${{ vars.BOT_EVAL_TIMEOUT_SEC || '1200' }}
  BOT_EVAL_MAX_ITERATIONS: ${{ vars.BOT_EVAL_MAX_ITERATIONS || '6' }}
  BOT_EVAL_HARD_TIMEOUT_SEC: ${{ vars.BOT_EVAL_HARD_TIMEOUT_SEC || '1200' }}
  BOT_EVAL_PYTHON: C:\actions-runner\python312\python.exe
  BOT_EVAL_BASELINE_DIR: ''

jobs:
  gate-pr:
    if: (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false) || (github.event_name == 'workflow_dispatch' && inputs.profile == 'pr')
    runs-on: ${{ vars.BOT_EVAL_RUNNER || 'self-hosted' }}
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            package.json
            package-lock.json
            tsconfig.json
            tsconfig.test.json
            scripts
            src
            test
            projects/bot_eval_run/release_baseline.txt
          sparse-checkout-cone-mode: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        shell: cmd
        run: npm ci

      - name: Verify Ollama connectivity
        shell: cmd
        run: |
          set "BASE_URL=%OLLAMA_BASE_URL%"
          if "%BASE_URL%"=="" set "BASE_URL=http://127.0.0.1:11434"
          curl --fail --silent --show-error "%BASE_URL%/api/tags" >nul
          if errorlevel 1 exit /b 1
          echo Ollama reachable at %BASE_URL%

      - name: Resolve baseline directory
        id: baseline
        shell: cmd
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -Command "$candidate = $env:BOT_EVAL_BASELINE_DIR; if ($null -eq $candidate) { $candidate = '' }; $candidate = $candidate.Trim(); if ([string]::IsNullOrWhiteSpace($candidate)) { $pointerPath = Join-Path $PWD 'projects\bot_eval_run\release_baseline.txt'; if (Test-Path $pointerPath) { $candidate = (Get-Content -Raw $pointerPath).Trim() } }; if ([string]::IsNullOrWhiteSpace($candidate)) { throw 'Release-gate baseline missing. Set repo variable BOT_EVAL_BASELINE_DIR or update projects/bot_eval_run/release_baseline.txt.' }; $resolved = [System.IO.Path]::GetFullPath($candidate); $resultsPath = Join-Path $resolved 'results.json'; if (-not (Test-Path $resultsPath)) { throw ('Baseline directory is invalid (results.json missing): ' + $resultsPath) }; ('baseline_dir=' + $resolved) | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append; Write-Host ('Using baseline: ' + $resolved)"
          if errorlevel 1 exit /b 1

      - name: Run release gate (3x3)
        id: gate
        shell: cmd
        run: |
          set "outDir=projects/bot_eval_run/release_gate_ci_pr_%GITHUB_RUN_ID%_%GITHUB_RUN_ATTEMPT%"
          echo out_dir=%outDir%>>%GITHUB_OUTPUT%
          npm run bot:eval:release-gate:ci -- --runs 3 --baseline "${{ steps.baseline.outputs.baseline_dir }}" --outDir "%outDir%"
          if errorlevel 1 exit /b 1

      - name: Upload gate artifacts
        if: always() && steps.gate.conclusion == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: bot-eval-release-gate-pr-${{ github.run_id }}-${{ github.run_attempt }}
          if-no-files-found: warn
          path: |
            ${{ steps.gate.outputs.out_dir }}/results.json
            ${{ steps.gate.outputs.out_dir }}/summary.json
            ${{ steps.gate.outputs.out_dir }}/compare.json

      - name: Cleanup old bot-eval directories (PR)
        if: always()
        shell: cmd
        run: |
          npm run bot:eval:cleanup -- --root projects/bot_eval_run --policy "release_gate_ci_pr_:10" --out "${{ steps.gate.outputs.out_dir }}/cleanup_report.json"
          if errorlevel 1 exit /b 1

  gate-nightly:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.profile == 'nightly')
    runs-on: ${{ vars.BOT_EVAL_RUNNER || 'self-hosted' }}
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            package.json
            package-lock.json
            tsconfig.json
            tsconfig.test.json
            scripts
            src
            test
            projects/bot_eval_run/release_baseline.txt
          sparse-checkout-cone-mode: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        shell: cmd
        run: npm ci

      - name: Verify Ollama connectivity
        shell: cmd
        run: |
          set "BASE_URL=%OLLAMA_BASE_URL%"
          if "%BASE_URL%"=="" set "BASE_URL=http://127.0.0.1:11434"
          curl --fail --silent --show-error "%BASE_URL%/api/tags" >nul
          if errorlevel 1 exit /b 1
          echo Ollama reachable at %BASE_URL%

      - name: Resolve baseline directory
        id: baseline
        shell: cmd
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -Command "$candidate = $env:BOT_EVAL_BASELINE_DIR; if ($null -eq $candidate) { $candidate = '' }; $candidate = $candidate.Trim(); if ([string]::IsNullOrWhiteSpace($candidate)) { $pointerPath = Join-Path $PWD 'projects\bot_eval_run\release_baseline.txt'; if (Test-Path $pointerPath) { $candidate = (Get-Content -Raw $pointerPath).Trim() } }; if ([string]::IsNullOrWhiteSpace($candidate)) { throw 'Release-gate baseline missing. Set repo variable BOT_EVAL_BASELINE_DIR or update projects/bot_eval_run/release_baseline.txt.' }; $resolved = [System.IO.Path]::GetFullPath($candidate); $resultsPath = Join-Path $resolved 'results.json'; if (-not (Test-Path $resultsPath)) { throw ('Baseline directory is invalid (results.json missing): ' + $resultsPath) }; ('baseline_dir=' + $resolved) | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append; Write-Host ('Using baseline: ' + $resolved)"
          if errorlevel 1 exit /b 1

      - name: Run release gate (15x3)
        id: gate
        shell: cmd
        run: |
          set "outDir=projects/bot_eval_run/release_gate_ci_nightly_%GITHUB_RUN_ID%_%GITHUB_RUN_ATTEMPT%"
          echo out_dir=%outDir%>>%GITHUB_OUTPUT%
          npm run bot:eval:release-gate -- --gateConfig scripts/config/botEvalGate.nightly.json --runs 15 --baseline "${{ steps.baseline.outputs.baseline_dir }}" --outDir "%outDir%"
          if errorlevel 1 exit /b 1

      - name: Resolve trend input runs
        if: steps.gate.conclusion == 'success'
        id: trend
        shell: cmd
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -Command "$root = Join-Path $PWD 'projects\bot_eval_run'; $dirs = Get-ChildItem $root -Directory | Where-Object { $_.Name -like 'release_gate_ci_nightly_*' } | Sort-Object LastWriteTime -Descending | Select-Object -First 3 -ExpandProperty FullName; if (-not $dirs -or $dirs.Count -eq 0) { throw 'No nightly run directories found for trend aggregation.' }; $inputs = ($dirs -join ','); ('trend_inputs=' + $inputs) | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append; Write-Host ('Trend inputs: ' + $inputs)"
          if errorlevel 1 exit /b 1

      - name: Build stability trend report
        if: steps.gate.conclusion == 'success'
        shell: cmd
        run: |
          npm run bot:eval:stability:aggregate -- --inputs "${{ steps.trend.outputs.trend_inputs }}" --out "${{ steps.gate.outputs.out_dir }}/stability_aggregate.json" --outMd "${{ steps.gate.outputs.out_dir }}/stability_aggregate.md"
          if errorlevel 1 exit /b 1

      - name: Latency guard (+25%)
        if: steps.gate.conclusion == 'success'
        id: latency_guard
        shell: cmd
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -Command "$outDir='${{ steps.gate.outputs.out_dir }}'; $comparePath = Join-Path $PWD ($outDir + '\compare.json'); if (-not (Test-Path $comparePath)) { throw ('Missing compare report: ' + $comparePath) }; $report = Get-Content -Raw $comparePath | ConvertFrom-Json; $maxMultiplier = 1.25; $violations = @(); foreach ($row in @($report.scenarios)) { $scenario = [string]$row.scenario; $baseAvg = [double]$row.baseline.avgMs; $candAvg = [double]$row.candidate.avgMs; $limit = [double]($baseAvg * $maxMultiplier); if ($baseAvg -le 0) { $violations += [pscustomobject]@{ scenario = $scenario; baselineAvgMs = $baseAvg; candidateAvgMs = $candAvg; limitAvgMs = $limit; reason = 'baselineAvgMs <= 0' }; continue }; if ($candAvg -gt $limit) { $violations += [pscustomobject]@{ scenario = $scenario; baselineAvgMs = $baseAvg; candidateAvgMs = $candAvg; limitAvgMs = $limit; reason = 'candidate avgMs exceeds 1.25x baseline' } } }; $outPath = Join-Path $PWD ($outDir + '\latency_guard.json'); $guard = [pscustomobject]@{ generatedAt = (Get-Date).ToString('o'); comparePath = $comparePath; maxAllowedMultiplier = $maxMultiplier; passed = ($violations.Count -eq 0); violations = $violations }; $guard | ConvertTo-Json -Depth 8 | Out-File -FilePath $outPath -Encoding utf8; if ($violations.Count -gt 0) { Write-Host ('Latency guard FAILED. Report: ' + $outPath); throw ('Latency guard failed with ' + $violations.Count + ' violation(s).') }; Write-Host ('Latency guard PASSED. Report: ' + $outPath)"
          if errorlevel 1 exit /b 1

      - name: Trend quality guard
        if: steps.gate.conclusion == 'success'
        id: trend_guard
        shell: cmd
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -Command "$outDir='${{ steps.gate.outputs.out_dir }}'; $aggregatePath = Join-Path $PWD ($outDir + '\stability_aggregate.json'); if (-not (Test-Path $aggregatePath)) { throw ('Missing stability aggregate report: ' + $aggregatePath) }; $agg = Get-Content -Raw $aggregatePath | ConvertFrom-Json; $violations = @(); if (-not [bool]$agg.allGatePassed) { $violations += [pscustomobject]@{ scope = 'aggregate'; message = 'allGatePassed is false' } }; foreach ($row in @($agg.scenarios)) { $scenario = [string]$row.scenario; $rawMin = [double]$row.rawRunPassRate.min; if ($rawMin -lt 1) { $violations += [pscustomobject]@{ scope = 'scenario'; scenario = $scenario; metric = 'rawRunPassRate.min'; actual = $rawMin; expected = 1 } }; $fallbackMax = [double]$row.fallbackDependencyRunRate.max; if ($fallbackMax -gt 0) { $violations += [pscustomobject]@{ scope = 'scenario'; scenario = $scenario; metric = 'fallbackDependencyRunRate.max'; actual = $fallbackMax; expected = 0 } }; $parse = $row.parseErrorRunsTotal; $planner = [int]$parse.planner; $jsonRepair = [int]$parse.jsonRepair; $schema = [int]$parse.schema; $jsonParse = [int]$parse.jsonParse; $placeholder = [int]$parse.placeholder; $other = [int]$parse.other; if (($planner + $jsonRepair + $schema + $jsonParse + $placeholder + $other) -gt 0) { $violations += [pscustomobject]@{ scope = 'scenario'; scenario = $scenario; metric = 'parseErrorRunsTotal'; planner = $planner; jsonRepair = $jsonRepair; schema = $schema; jsonParse = $jsonParse; placeholder = $placeholder; other = $other; expectedAllZero = $true } } }; $outPath = Join-Path $PWD ($outDir + '\trend_guard.json'); $guard = [pscustomobject]@{ generatedAt = (Get-Date).ToString('o'); aggregatePath = $aggregatePath; passed = ($violations.Count -eq 0); violations = $violations }; $guard | ConvertTo-Json -Depth 8 | Out-File -FilePath $outPath -Encoding utf8; if ($violations.Count -gt 0) { Write-Host ('Trend quality guard FAILED. Report: ' + $outPath); throw ('Trend quality guard failed with ' + $violations.Count + ' violation(s).') }; Write-Host ('Trend quality guard PASSED. Report: ' + $outPath)"
          if errorlevel 1 exit /b 1

      - name: Build nightly calibration recommendation
        if: steps.gate.conclusion == 'success' && steps.trend_guard.conclusion == 'success'
        shell: cmd
        run: |
          npm run bot:eval:nightly:calibrate -- --window 10 --root projects/bot_eval_run --out "${{ steps.gate.outputs.out_dir }}/calibration_recommendation.json" --outMd "${{ steps.gate.outputs.out_dir }}/calibration_recommendation.md"
          if errorlevel 1 exit /b 1

      - name: Guarded baseline promotion
        if: steps.gate.conclusion == 'success' && steps.latency_guard.conclusion == 'success' && steps.trend_guard.conclusion == 'success'
        shell: cmd
        run: |
          npm run bot:eval:baseline:promote -- --candidate "${{ steps.gate.outputs.out_dir }}" --stable "${{ steps.baseline.outputs.baseline_dir }}" --state "C:\actions-runner\release_gate_promotion_state_node_api.json" --requiredConsecutive 2 --scenario "node-api-oracle" --minRawRunPassRate 1 --maxFallbackDependencyRunRate 0 --out "${{ steps.gate.outputs.out_dir }}/baseline_promotion.json"
          if errorlevel 1 exit /b 1

      - name: Upload gate artifacts
        if: always() && steps.gate.conclusion == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: bot-eval-release-gate-nightly-${{ github.run_id }}-${{ github.run_attempt }}
          if-no-files-found: warn
          path: |
            ${{ steps.gate.outputs.out_dir }}/results.json
            ${{ steps.gate.outputs.out_dir }}/summary.json
            ${{ steps.gate.outputs.out_dir }}/compare.json
            ${{ steps.gate.outputs.out_dir }}/stability_aggregate.json
            ${{ steps.gate.outputs.out_dir }}/stability_aggregate.md
            ${{ steps.gate.outputs.out_dir }}/latency_guard.json
            ${{ steps.gate.outputs.out_dir }}/trend_guard.json
            ${{ steps.gate.outputs.out_dir }}/calibration_recommendation.json
            ${{ steps.gate.outputs.out_dir }}/calibration_recommendation.md
            ${{ steps.gate.outputs.out_dir }}/baseline_promotion.json

      - name: Cleanup old bot-eval directories (nightly)
        if: always()
        shell: cmd
        run: |
          npm run bot:eval:cleanup -- --root projects/bot_eval_run --policy "release_gate_ci_nightly_:10" --policy "release_gate_ci_pr_:10" --out "${{ steps.gate.outputs.out_dir }}/cleanup_report.json"
          if errorlevel 1 exit /b 1
